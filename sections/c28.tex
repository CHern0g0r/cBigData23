\section{Apache Kafka. Гарантии доставки сообщений. Дублирование сообщений.}

\subsection*{Гарантии доставки}

При записи продюсер может ждать или не ждать 
acknowledgment (ack, признание, подтверждение).
Ack – это подтверждение со стороны получателя о получении и 
сохранении записи.

Ack может быть 3-ех значений:
\begin{itemize}
    \item Acks=0 (не ждать подтверждения)
    \item Acks=1 (ждем подтверждения только от Leader)
    \item Acks=-1 (ждем подтверждения от Leader и реплик)
\end{itemize}


\subsection*{Дублирование сообщений}

\begin{itemize}
    \item Продюсер отправляет сообщение Кафке
    \item Сообщение было успешно написано и реплицировано
    \item Проблемы с сетью не позволили подтверждению достичь производителя.
    \item Производитель повторит попытку отправки сообщения 
    \item Брокер получит одно и то же сообщение дважды
\end{itemize}

\textbf{Решение = Idempotent Producer}

Идемпотентность гарантирует, что дубликатов не будет.

Каждый продюсер получает (со стороны брокера) уникальный PID.

Каждое сообщение получает монотонно увеличивающийся порядковый номер Seq.

В случае если у сообщения порядковый номер точно не на единицу больше, чем 
последнее зафиксированное сообщение брокер не запишет дважды и отдаст 
подтверждение продьсеру, 
получаем строго однократную доставку - \textbf{exactly once}.

